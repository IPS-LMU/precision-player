<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Precision Player Experiment Demo</title>
    <link rel="stylesheet" href="style.experiment.css">
    <script type="text/javascript" src="../dist/js/precision_player.js"></script>
    <script type="text/javascript">
        /*
            list of audio players and their current state
            each element has the structure
            {
                filename: string | File; // if URL string, it's loaded automatically
                currentPlaybacks: number;
                maxPlaybacks: number;
                status: string;
                player: PrecisionPlayer;
            }
         */
        var audioPlayers = [];
        var playerSettings = {
            downloadAudio: true
        };

        var positionChecker = () => {
            requestAnimationFrame(() => {
                for (const audioPlayer of audioPlayers) {
                    const playerPositionCell = document.getElementById("player-position-" + audioPlayer.player.id);
                    if (playerPositionCell) {
                        playerPositionCell.innerText = Math.round(audioPlayer.player.currentTime) + "/" + Math.round(audioPlayer.player.audioInformation.audioMechanism.duration);
                    }
                }
                positionChecker();
            });
        }
        positionChecker();
        // if you want to update this array when events are handled, you have to update it

        // wait until the dom is ready
        document.addEventListener('DOMContentLoaded', function () {
            // HTML Elements
            const fileSelection = document.getElementById("fileselection");

            fileSelection.addEventListener("change", (e) => {
                onFileSelectionChange(e, "add");
            });
        });

        /**
         * Event handler for change event of file selection.
         * @param e the ChangeEvent object
         * @param type
         * @param id
         */
        function onFileSelectionChange(e, type, id) {
            const file = e.target.files[0];
            if (file) {
                if (type === "add") {
                    const player = new PrecisionPlayer.AudioPlayer("WebAudio", playerSettings);

                    // add audioplayer state to array
                    // it's not needed in this demo, but still added
                    const audioplayerObj = {
                        fileSource: file,
                        currentPlaybacks: 0,
                        maxPlaybacks: 5,
                        status: "INITIALIZED",
                        protocol: [],
                        player: player
                    };

                    audioPlayers.push(audioplayerObj);

                    // react to audio events
                    let lastAbsolute = performance.timeOrigin + performance.now();
                    lastNow = Date.now();
                    player.onStatusChange.addEventListener((pEvent) => {
                        audioplayerObj.protocol.push(pEvent);
                        const absoluteValue = PrecisionPlayer.roundHighResTimestamp(pEvent.timingRecord.eventTriggered.highResolution);
                        /*console.log(`---- now: ${Date.now()}
highRes:  ${absoluteValue}       (${new Date(PrecisionPlayer.roundHighResTimestamp(absoluteValue)).toISOString()})
now:      ${pEvent.timingRecord.eventTriggered.nowMethod}           (${new Date(pEvent.timingRecord.eventTriggered.nowMethod).toISOString()})

----`);
                         */
                        //console.log(`diff to last with highres: ${absoluteValue - lastAbsolute}ms, now: ${pEvent.timingRecord.eventTriggered.nowMethod - lastNow}ms;\t highres is ${(absoluteValue - lastAbsolute) - (pEvent.timingRecord.eventTriggered.nowMethod - lastNow)}ms bigger`);
                        //console.log(`audio ${pEvent.status} highRes: ${pEvent.timingRecord.eventTriggered.highResolution}, ${pEvent.timingRecord.eventTriggered.nowMethod - absoluteValue}`);
                        lastAbsolute = absoluteValue;
                        lastNow = pEvent.timingRecord.eventTriggered.nowMethod;
                        if (pEvent.status !== "INITIALIZED" && pEvent.status !== "FAILED") {
                            if (pEvent.status === "READY") {
                                audioplayerObj.status = pEvent.status;
                                addAudioPlayerToUI(audioplayerObj);
                                checkButtons(pEvent.status, player.id);
                            }
                            const statusCell = document.getElementById("player-status-" + player.id);
                            statusCell.innerHTML = pEvent.status;
                            const logArea = document.getElementById("log-area-" + player.id);
                            logArea.value = getLogString(audioplayerObj.protocol);
                            updatetLogTable(player.id, audioplayerObj.protocol);
                            checkButtons(pEvent.status, player.id);
                            if (pEvent.status === "ENDED") {
                                increaseCurrentPlaybacks(audioplayerObj);
                            }
                        } else if (pEvent.status === "FAILED") {
                            console.error("ERROR: " + pEvent.message);
                        }
                    });

                    player.initialize(file);
                } else {
                    const index = audioPlayers.findIndex(a => a.player.id === id);
                    const player = audioPlayers[index].player;
                    audioPlayers[index].fileSource = file;
                    player.initialize(file);
                }
            }
        }

        /**
         * Append an audio player entry to the table
         * @param audioPlayerObj
         */
        function addAudioPlayerToUI(audioPlayerObj) {
            const line = document.getElementById("player-line-" + audioPlayerObj.player.id);
            let previousElement = null;

            if (line) {
                const line2 = document.getElementById("player-audio-information-" + audioPlayerObj.player.id);
                previousElement = line.previousSibling;
                line.remove();
                line2.remove();
            }

            const audioPlayerTBody = document.getElementById("audiofiles-list");
            const trElement = document.createElement("tr");
            trElement.setAttribute("id", "player-line-" + audioPlayerObj.player.id);

            const idCell = document.createElement("td");
            idCell.innerHTML = audioPlayerObj.player.id;
            trElement.appendChild(idCell);

            const nameCell = document.createElement("td");
            nameCell.innerHTML = audioPlayerObj.player.audioInformation.file.fullName;
            trElement.appendChild(nameCell);

            const playerCell = document.createElement("td");
            playerCell.setAttribute("id", "player-ui-" + audioPlayerObj.player.id);
            addPlayerUI(playerCell, audioPlayerObj);
            trElement.appendChild(playerCell);

            const statusCell = document.createElement("td");
            statusCell.setAttribute("class", "status-cell");
            statusCell.setAttribute("id", "player-status-" + audioPlayerObj.player.id);
            statusCell.innerHTML = audioPlayerObj.status;
            trElement.appendChild(statusCell);

            const positionCell = document.createElement("td");
            positionCell.setAttribute("class", "position-cell");
            positionCell.setAttribute("id", "player-position-" + audioPlayerObj.player.id);
            positionCell.innerHTML = audioPlayerObj.player.currentTime;
            trElement.appendChild(positionCell);

            const currentPlaybacksCell = document.createElement("td");
            currentPlaybacksCell.setAttribute("id", "player-current-playbacks-" + audioPlayerObj.player.id);
            currentPlaybacksCell.innerHTML = audioPlayerObj.currentPlaybacks;
            trElement.appendChild(currentPlaybacksCell);

            const maxPlaybacksCell = document.createElement("td");
            maxPlaybacksCell.innerHTML = audioPlayerObj.maxPlaybacks;
            trElement.appendChild(maxPlaybacksCell);

            const actionsCell = document.createElement("td");
            const downloadLog = document.createElement("a");
            downloadLog.setAttribute("id", "save-log-" + audioPlayerObj.player.id);
            downloadLog.setAttribute("download", "");
            downloadLog.setAttribute("href", "");
            downloadLog.innerHTML = "Save Log ";
            actionsCell.appendChild(downloadLog);

            const removeButton = document.createElement("button");
            removeButton.innerHTML = "Remove";
            removeButton.addEventListener("click", function () {
                audioPlayerObj.player.destroy();
                document.getElementById("player-line-" + audioPlayerObj.player.id).remove();
                document.getElementById("player-audio-information-" + audioPlayerObj.player.id).remove();
            });
            actionsCell.appendChild(removeButton);

            const changeButton = document.createElement("input");
            changeButton.setAttribute("type", "file");
            changeButton.setAttribute("value", "Select an audio file");
            changeButton.addEventListener("change", function (e) {
                onFileSelectionChange(e, "change", audioPlayerObj.player.id);
            });

            actionsCell.appendChild(changeButton);
            trElement.appendChild(actionsCell);

            if (previousElement) {
                previousElement.after(createAudioInformationLine(audioPlayerObj));
                previousElement.after(trElement);
            } else {
                audioPlayerTBody.appendChild(trElement);
                audioPlayerTBody.appendChild(createAudioInformationLine(audioPlayerObj));
            }
        }

        /**
         * Append the table row for audio information
         * @param audioPlayerObj
         */
        function createAudioInformationLine(audioPlayerObj) {
            const trElement = document.createElement("tr");
            trElement.setAttribute("id", "player-audio-information-" + audioPlayerObj.player.id);

            const idCell = document.createElement("td");
            idCell.innerHTML = "";
            trElement.appendChild(idCell);

            const audioInformationCell = document.createElement("td");
            audioInformationCell.setAttribute("colspan", "3");
            const textArea = document.createElement("textarea");
            textArea.setAttribute("class", "audio-information-area");
            textArea.value = JSON.stringify(audioPlayerObj.player.audioInformation, null, 2);
            audioInformationCell.appendChild(textArea);

            const logInformationCell = document.createElement("td");
            logInformationCell.setAttribute("colspan", "5");
            const textAreaLog = document.createElement("textarea");
            textAreaLog.setAttribute("class", "log-area");
            textAreaLog.setAttribute("id", "log-area-" + audioPlayerObj.player.id);
            textAreaLog.value = getLogString(audioPlayerObj.protocol);
            updatetLogTable(audioPlayerObj.player.id, audioPlayerObj.protocol);
            logInformationCell.appendChild(textAreaLog);

            trElement.appendChild(audioInformationCell);
            trElement.appendChild(logInformationCell);

            return trElement;
        }

        /**
         * append the player ui with its buttons etc.
         * @param playerCell The HTMLElement the player should be appended
         * @param audioPlayerObj
         */
        function addPlayerUI(playerCell, audioPlayerObj) {
            const playButton = document.createElement("button");
            playButton.setAttribute("id", "player-button-play-" + audioPlayerObj.player.id);
            playButton.setAttribute("disabled", "disabled");
            playButton.innerHTML = "PLAY";
            playerCell.appendChild(playButton);
            playButton.addEventListener("click", function (e) {
                console.log(`button play: highRes: ${e.timeStamp}, ${Date.now() - (e.timeStamp)} faster`);
                audioPlayerObj.player.play();
            });

            const pauseButton = document.createElement("button");
            pauseButton.setAttribute("id", "player-button-pause-" + audioPlayerObj.player.id);
            pauseButton.setAttribute("disabled", "disabled");
            pauseButton.innerHTML = "PAUSE";
            pauseButton.addEventListener("click", function (e) {
                console.log(`button pause: highRes: ${e.timeStamp}, ${Date.now() - (e.timeStamp)} faster`);
                audioPlayerObj.player.pause();
            });
            playerCell.appendChild(pauseButton);

            const stopButton = document.createElement("button");
            stopButton.setAttribute("id", "player-button-stop-" + audioPlayerObj.player.id);
            stopButton.setAttribute("disabled", "disabled");
            stopButton.innerHTML = "STOP";
            stopButton.addEventListener("click", function () {
                audioPlayerObj.player.stop();
            });
            playerCell.appendChild(stopButton);
        }

        /**
         * Increased the current playbacks and reacts of maximum playbacks exceeded
         * @param audioplayerObj
         */
        function increaseCurrentPlaybacks(audioplayerObj) {
            audioplayerObj.currentPlaybacks++;
            const currentPlaybacks = document.getElementById("player-current-playbacks-" + audioplayerObj.player.id);
            currentPlaybacks.innerHTML = audioplayerObj.currentPlaybacks;

            if (audioplayerObj.currentPlaybacks === audioplayerObj.maxPlaybacks) {
                // deactivate player buttons
                const playerUI = document.getElementById("player-ui-" + audioplayerObj.player.id);
                if (playerUI) {
                    const buttons = playerUI.getElementsByTagName("button");
                    for (var i = 0; i < buttons.length; i++) {
                        const child = buttons[i];
                        child.setAttribute("disabled", "disabled");
                    }
                }
            }
        }

        /**
         * checks the play buttons of an audio player and if a reaction is needed.
         * @param status
         * @param id
         */
        function checkButtons(status, id) {
            const playButton = document.getElementById("player-button-play-" + id);
            const pauseButton = document.getElementById("player-button-pause-" + id);
            const stopButton = document.getElementById("player-button-stop-" + id);

            if (status === "PLAYING") {
                playButton.setAttribute("disabled", "disabled");
                pauseButton.removeAttribute("disabled");
                stopButton.removeAttribute("disabled");
            } else {
                playButton.removeAttribute("disabled");
                pauseButton.setAttribute("disabled", "disabled");
                stopButton.setAttribute("disabled", "disabled");
            }
        }

        function getLogString(logs) {
            let result = "";
            let lastTriggered = (logs.length > 0) ? logs[0].timingRecord.eventTriggered : -1;
            for (const log of logs) {
                result += `\n${new Date(log.timingRecord.eventTriggered.nowMethod).toLocaleString()} (${log.status}): playbackDurAudio (${log.timingRecord.playbackDuration.audioMechanism}) playbackDurEvents (${log.timingRecord.playbackDuration.eventCalculation}), diffEventsByNow (${(log.timingRecord.eventTriggered.nowMethod - lastTriggered.nowMethod)}ms), diffEventsByHighRes (${log.timingRecord.eventTriggered.highResolution - lastTriggered.highResolution}ms)`;
                lastTriggered = log.timingRecord.eventTriggered;
            }
            return result;
        }

        function updatetLogTable(id, logs) {
            let result = "";
            let lastTriggered = (logs.length > 0) ? logs[0].timingRecord.eventTriggered : -1;
            result += "Timestamp\tstatus\tplaybackDurAudio\tplaybackDurEvents\tdiffEventsByNow\tdiffEventsByHighRes\n";
            for (const log of logs) {
                result += `${log.timingRecord.eventTriggered.nowMethod}\t${log.status}\t${log.timingRecord.playbackDuration.audioMechanism}\t${log.timingRecord.playbackDuration.eventCalculation}\t${(log.timingRecord.eventTriggered.nowMethod - lastTriggered.nowMethod)}\t${log.timingRecord.eventTriggered.highResolution - lastTriggered.highResolution}\n`;
                lastTriggered = log.timingRecord.eventTriggered;
            }
            const fileName = "expDemp_logs_" + Date.now() + ".txt";
            const url = URL.createObjectURL(new File([result], fileName, {
                type: "text",
            }));
            const downloadLog = document.getElementById("save-log-" + id);

            if (downloadLog) {
                downloadLog.setAttribute("href", url);
                downloadLog.setAttribute("download", fileName);
            }
        }
    </script>
</head>
<body>
<h1>Experiment Demo</h1>
<p>Test demo for using the precision player in an web experiment. It creates an audio player for each audio file.</p>
<table>
    <tbody>
    <tr>
        <td>Add an audio file:</td>
        <td>
            <input type="file" id="fileselection" value="Select an audio file"/>
        </td>
    </tr>
    </tbody>
</table>

<h3>List of audio files</h3>
<table id="audiofile-table">
    <thead>
    <tr>
        <th>ID</th>
        <th>name of audio file</th>
        <th>player</th>
        <th class="status-cell">status</th>
        <th>Position</th>
        <th>playbacks</th>
        <th>maximum playbacks</th>
        <th>actions</th>
    </tr>
    </thead>
    <tbody id="audiofiles-list">

    </tbody>
</table>
</body>
</html>
