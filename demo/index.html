<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Precision Player Demo</title>
    <link rel="stylesheet" href="./precision-player.css">
    <script type="text/javascript" src="./precision_player.js"></script>
    <script type="text/javascript">
      // Player realated variables
      let player;

      document.addEventListener('DOMContentLoaded', () => {
        // HTML Elements
        const playerUI = document.getElementById("player");
        let file;
        const htmlAudioRadioButton = document.getElementById("htmlAudioRabioButton");
        const weblAudioRadioButton = document.getElementById("webAudioRabioButton");

        const initializePlayer = (mechanism) => {
          console.log(`init player`);
          if (player) {
            console.log(`destroy old player`);
            player.destroy();
          }

          player = new PrecisionPlayer.AudioPlayer(mechanism, {
            downloadAudio: true,
            headers: {
              'Authorization': 'Basic ' + btoa("Julian" + ":" + "test1234")
            }
          }, playerUI);
          const playing = {
            started: -1,
            ended: -1,
            played: 0
          }
          player.onStatusChange.addEventListener((pEvent) => {
            console.log(pEvent);

            if (pEvent.status === "PLAYING") {
              playing.started = pEvent.timingRecord.eventTriggered;
            } else if (pEvent.status === "ENDED" || pEvent.status === "STOPPED") {
              playing.ended = pEvent.timingRecord.eventTriggered;
              playing.played = 0;
            }

            if (pEvent.status === "PAUSED") {
              playing.ended = pEvent.timingRecord.eventTriggered;
              const eventDuration = playing.ended - playing.started;
              playing.played += eventDuration;
            }
          });
        };

        const checkRadioButtons = (e) => {
          initializePlayer(e.target.value);
          if (!player) {
            initializeFileSelection();
          } else {
            player.initialize("http://192.168.178.36:8081/Bahnauskunft.wav");
          }
        }

        const initializeFileSelection = () => {
          const fileSelection = document.createElement("input");
          fileSelection.setAttribute("id", "file-selection");
          fileSelection.setAttribute("type", "file");
          fileSelection.setAttribute("name", "file");

          const fileSelectionPlace = document.getElementById("fileSelectionPlace");
          for (const child of fileSelectionPlace.children) {
            fileSelectionPlace.removeChild(child);
          }
          fileSelectionPlace.appendChild(fileSelection);
          fileSelection.onchange = (e) => {
            file = e.target.files[0];
            if (file) {
              player.initialize(file)
            }
          }
        };

        htmlAudioRadioButton.onchange = checkRadioButtons;
        weblAudioRadioButton.onchange = checkRadioButtons;
        initializeFileSelection();
      });

      function backSkip() {
        player.play(player.currentTime - 0.5);
      }

      function test() {
        const audio = document.getElementById("audioElement");
        const source = document.createElement("source");
        source.src = "http://192.168.178.36:8081/Bahnauskunft.wav";
        audio.appendChild(source);
      }
    </script>
</head>
<body>
<h1>Demo</h1>
<p>Set options</p>
<table>
    <tbody>
    <tr>
        <td>Select audio mechanism:</td>
        <td>
            <input type="radio" name="mechanism" id="htmlAudioRabioButton" value="HTMLAudio"/>
            <label for="htmlAudioRabioButton">HTML-Audio</label><br/>
            <input type="radio" name="mechanism" id="webAudioRabioButton" value="WebAudio"/>
            <label for="webAudioRabioButton">Web-Audio</label><br/>
        </td>
    </tr>
    </tbody>
</table>
<p>Select a file</p>
<div id="fileSelectionPlace"></div>
<div id="player">
</div>
<button onclick="backSkip()" style="margin-top:10px;">‚èÆ</button>
<audio controls id="audioElement" crossorigin="use-credentials"></audio>
<button onclick="test()">test</button>
</body>
</html>
